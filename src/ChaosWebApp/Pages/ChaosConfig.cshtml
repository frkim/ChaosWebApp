@page
@model ChaosWebApp.Pages.ChaosConfigModel
@{
    ViewData["Title"] = "Chaos Simulator";
}

<div class="d-flex align-items-center gap-3 mb-4">
    <div class="chaos-icon-bg rounded-3 p-3 text-warning">
        <i class="fas fa-radiation fa-2x"></i>
    </div>
    <div>
        <h1 class="h2 mb-1">Chaos Simulator</h1>
        <p class="text-muted mb-0">Configure failures and performance issues to inject into the application</p>
    </div>
    <!-- Status pill -->
    @if (Model.Config.IsEnabled)
    {
        <span class="badge bg-danger fs-6 px-3 py-2 chaos-pulse ms-auto">
            <i class="fas fa-radiation me-1"></i>CHAOS ACTIVE
        </span>
    }
    else
    {
        <span class="badge bg-secondary fs-6 px-3 py-2 ms-auto">
            <i class="fas fa-power-off me-1"></i>INACTIVE
        </span>
    }
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show shadow-sm" role="alert">
        <i class="fas fa-check-circle me-2"></i>@TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<form method="post" asp-page-handler="Save">
    @Html.AntiForgeryToken()

    <div class="row g-4">

        <!-- Column 1: Global Settings + Chaos Types -->
        <div class="col-lg-7">

            <!-- Global toggle -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-dark text-white">
                    <i class="fas fa-toggle-on me-2"></i>Global Activation
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="isEnabled" name="IsEnabled" value="true"
                               @(Model.Config.IsEnabled ? "checked" : "") role="switch" style="width:3em;height:1.5em" />
                        <label class="form-check-label fw-semibold ms-2" for="isEnabled">
                            Enable chaos simulator
                        </label>
                    </div>

                    <!-- Target -->
                    <label class="form-label fw-semibold">Target</label>
                    <div class="d-flex gap-3">
                        @foreach (var target in Enum.GetValues<ChaosWebApp.Models.ChaosTarget>())
                        {
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="Target" value="@((int)target)" id="target_@target"
                                       @(Model.Config.Target == target ? "checked" : "") />
                                <label class="form-check-label" for="target_@target">@target</label>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Chaos types -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-dark text-white d-flex align-items-center">
                    <i class="fas fa-bug me-2"></i>Fault Types to Inject
                    <div class="ms-auto d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-outline-light" id="selectAll">
                            <i class="fas fa-check-double me-1"></i>All
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-light" id="selectNone">
                            <i class="fas fa-times me-1"></i>None
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-warning" id="selectRandom">
                            <i class="fas fa-dice me-1"></i>Random
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        @{
                            void ChaosCheckbox(string id, string label, string icon, string description, bool isChecked)
                            {
                                <div class="col-md-6">
                                    <label class="chaos-type-card border rounded-3 p-3 d-flex align-items-start gap-2 w-100" for="@id">
                                        <input class="form-check-input mt-0 flex-shrink-0" type="checkbox" id="@id" name="@id" value="true" @(isChecked ? "checked" : "") />
                                        <div>
                                            <div class="fw-semibold small"><i class="@icon me-1 text-danger"></i>@label</div>
                                            <div class="text-muted" style="font-size:.78rem">@description</div>
                                        </div>
                                    </label>
                                </div>
                            }
                        }
                        @{ ChaosCheckbox("EnableHighCpu", "High CPU", "fas fa-microchip", "Intensive computation blocking the CPU", Model.Config.EnableHighCpu); }
                        @{ ChaosCheckbox("EnableHighMemory", "High Memory", "fas fa-memory", "Massive RAM memory allocation", Model.Config.EnableHighMemory); }
                        @{ ChaosCheckbox("EnableHighLatency", "High Latency", "fas fa-clock", "Delay before processing the request", Model.Config.EnableHighLatency); }
                        @{ ChaosCheckbox("EnableSlowResponse", "Slow Response", "fas fa-hourglass-half", "Delay after processing, before response", Model.Config.EnableSlowResponse); }
                        @{ ChaosCheckbox("EnableError404", "Error 404", "fas fa-search-minus", "Resource not found", Model.Config.EnableError404); }
                        @{ ChaosCheckbox("EnableError500", "Error 500", "fas fa-bomb", "Internal server error", Model.Config.EnableError500); }
                        @{ ChaosCheckbox("EnableError503", "Error 503", "fas fa-server", "Service temporarily unavailable", Model.Config.EnableError503); }
                        @{ ChaosCheckbox("EnableError429", "Error 429", "fas fa-ban", "Too many requests (rate limiting)", Model.Config.EnableError429); }
                        @{ ChaosCheckbox("EnableStackOverflow", "Stack Overflow", "fas fa-infinity", "Simulated stack overflow", Model.Config.EnableStackOverflow); }
                        @{ ChaosCheckbox("EnableLongStartup", "Long Startup", "fas fa-hourglass-start", "Application takes a long time to initialize", Model.Config.EnableLongStartup); }
                    </div>
                </div>
            </div>
        </div>

        <!-- Column 2: Parameters + Frequency -->
        <div class="col-lg-5">

            <!-- Parameters -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-dark text-white">
                    <i class="fas fa-sliders-h me-2"></i>Parameters
                </div>
                <div class="card-body">
                    <!-- Global master gauge -->
                    <div class="mb-4 p-3 border rounded-3 bg-light">
                        <label class="form-label small fw-semibold" for="globalGauge">
                            <i class="fas fa-volume-up text-primary me-1"></i>Global Intensity
                        </label>
                        <div class="d-flex align-items-center gap-3">
                            <i class="fas fa-volume-off text-muted"></i>
                            <input type="range" class="form-range gauge-slider gauge-global flex-grow-1" id="globalGauge"
                                   min="0" max="100" value="50" />
                            <i class="fas fa-volume-up text-muted"></i>
                            <span class="badge bg-primary gauge-value-badge" id="globalGaugeValue">50%</span>
                        </div>
                        <div class="form-text">Proportionally adjusts all parameters below</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-semibold" for="CpuDurationMs">
                            <i class="fas fa-microchip text-danger me-1"></i>CPU Duration (ms)
                        </label>
                        <div class="d-flex align-items-center gap-3">
                            <i class="fas fa-volume-off text-muted small"></i>
                            <input type="range" class="form-range gauge-slider gauge-param flex-grow-1" id="CpuDurationMs_range"
                                   min="100" max="30000" step="100" value="@Model.Config.CpuDurationMs"
                                   data-target="CpuDurationMs" data-min="100" data-max="30000" />
                            <i class="fas fa-volume-up text-muted small"></i>
                            <span class="badge bg-danger gauge-value-badge" id="CpuDurationMs_val">@Model.Config.CpuDurationMs</span>
                        </div>
                        <input type="hidden" id="CpuDurationMs" name="CpuDurationMs" value="@Model.Config.CpuDurationMs" />
                        <div class="form-text">Intensive CPU computation duration (100–30,000 ms)</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-semibold" for="MemorySizeMb">
                            <i class="fas fa-memory text-danger me-1"></i>Memory Size (MB)
                        </label>
                        <div class="d-flex align-items-center gap-3">
                            <i class="fas fa-volume-off text-muted small"></i>
                            <input type="range" class="form-range gauge-slider gauge-param flex-grow-1" id="MemorySizeMb_range"
                                   min="10" max="2000" step="10" value="@Model.Config.MemorySizeMb"
                                   data-target="MemorySizeMb" data-min="10" data-max="2000" />
                            <i class="fas fa-volume-up text-muted small"></i>
                            <span class="badge bg-danger gauge-value-badge" id="MemorySizeMb_val">@Model.Config.MemorySizeMb</span>
                        </div>
                        <input type="hidden" id="MemorySizeMb" name="MemorySizeMb" value="@Model.Config.MemorySizeMb" />
                        <div class="form-text">Amount of memory to allocate (10–2,000 MB)</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-semibold" for="LatencyMs">
                            <i class="fas fa-clock text-danger me-1"></i>Latency (ms)
                        </label>
                        <div class="d-flex align-items-center gap-3">
                            <i class="fas fa-volume-off text-muted small"></i>
                            <input type="range" class="form-range gauge-slider gauge-param flex-grow-1" id="LatencyMs_range"
                                   min="100" max="60000" step="100" value="@Model.Config.LatencyMs"
                                   data-target="LatencyMs" data-min="100" data-max="60000" />
                            <i class="fas fa-volume-up text-muted small"></i>
                            <span class="badge bg-danger gauge-value-badge" id="LatencyMs_val">@Model.Config.LatencyMs</span>
                        </div>
                        <input type="hidden" id="LatencyMs" name="LatencyMs" value="@Model.Config.LatencyMs" />
                        <div class="form-text">Delay added before processing (100–60,000 ms)</div>
                    </div>
                    <div class="mb-0">
                        <label class="form-label small fw-semibold" for="SlowResponseMs">
                            <i class="fas fa-hourglass-half text-danger me-1"></i>Slow Response (ms)
                        </label>
                        <div class="d-flex align-items-center gap-3">
                            <i class="fas fa-volume-off text-muted small"></i>
                            <input type="range" class="form-range gauge-slider gauge-param flex-grow-1" id="SlowResponseMs_range"
                                   min="100" max="60000" step="100" value="@Model.Config.SlowResponseMs"
                                   data-target="SlowResponseMs" data-min="100" data-max="60000" />
                            <i class="fas fa-volume-up text-muted small"></i>
                            <span class="badge bg-danger gauge-value-badge" id="SlowResponseMs_val">@Model.Config.SlowResponseMs</span>
                        </div>
                        <input type="hidden" id="SlowResponseMs" name="SlowResponseMs" value="@Model.Config.SlowResponseMs" />
                        <div class="form-text">Delay added after processing (100–60,000 ms)</div>
                    </div>
                    <div class="mb-0 @(Model.Config.EnableLongStartup ? "" : "d-none")" id="startupDurationSection">
                        <label class="form-label small fw-semibold">
                            <i class="fas fa-hourglass-start text-danger me-1"></i>Startup Duration Range (ms)
                        </label>
                        <div class="dual-range-wrap">
                            <div class="dual-range-track">
                                <div class="dual-range-fill" id="startupFill"></div>
                            </div>
                            <input type="range" class="dual-range dual-range-min" id="StartupDurationMinMs_range"
                                   min="1000" max="300000" step="1000" value="@Model.Config.StartupDurationMinMs" />
                            <input type="range" class="dual-range dual-range-max" id="StartupDurationMaxMs_range"
                                   min="1000" max="300000" step="1000" value="@Model.Config.StartupDurationMaxMs" />
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <span class="badge bg-danger gauge-value-badge" id="StartupDurationMinMs_val">@Model.Config.StartupDurationMinMs</span>
                            <span class="badge bg-danger gauge-value-badge" id="StartupDurationMaxMs_val">@Model.Config.StartupDurationMaxMs</span>
                        </div>
                        <input type="hidden" id="StartupDurationMinMs" name="StartupDurationMinMs" value="@Model.Config.StartupDurationMinMs" />
                        <input type="hidden" id="StartupDurationMaxMs" name="StartupDurationMaxMs" value="@Model.Config.StartupDurationMaxMs" />
                        <div class="form-text">Min–Max startup initialization delay (1,000–300,000 ms)</div>
                    </div>
                </div>
            </div>

            <!-- Frequency -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-dark text-white">
                    <i class="fas fa-wave-square me-2"></i>Injection Frequency
                </div>
                <div class="card-body">
                    @{
                        void FrequencyOption(string value, string label, string icon, bool isChecked)
                        {
                            <label class="frequency-card border rounded-3 p-3 mb-3 d-flex align-items-center gap-2 w-100" for="freq_@value">
                                <input class="form-check-input" type="radio" name="FrequencyType" value="@value"
                                       id="freq_@value" @(isChecked ? "checked" : "") />
                                <i class="@icon text-primary"></i>
                                <span class="small fw-semibold">@label</span>
                            </label>
                        }
                    }
                    @{ FrequencyOption("2", "Percentage", "fas fa-percent", Model.Config.FrequencyType == ChaosWebApp.Models.FrequencyType.Percentage); }
                    <div class="ms-4 mb-3">
                        <div class="d-flex align-items-center gap-3">
                            <i class="fas fa-volume-off text-muted small"></i>
                            <input type="range" class="form-range gauge-slider gauge-percentage flex-grow-1" id="Percentage_range"
                                   min="1" max="100" step="1" value="@Model.Config.Percentage" />
                            <i class="fas fa-volume-up text-muted small"></i>
                            <span class="badge bg-primary gauge-value-badge" id="Percentage_val">@Model.Config.Percentage%</span>
                        </div>
                        <input type="hidden" id="Percentage" name="Percentage" value="@Model.Config.Percentage" />
                    </div>

                    @{ FrequencyOption("0", "Every N Requests", "fas fa-list-ol", Model.Config.FrequencyType == ChaosWebApp.Models.FrequencyType.EveryNRequests); }
                    <div class="ms-4 mb-3">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">Once every</span>
                            <input type="number" class="form-control" name="EveryNRequests" value="@Model.Config.EveryNRequests" min="1" max="1000" />
                            <span class="input-group-text">requests</span>
                        </div>
                    </div>

                    @{ FrequencyOption("1", "Every N Seconds", "fas fa-stopwatch", Model.Config.FrequencyType == ChaosWebApp.Models.FrequencyType.EveryNSeconds); }
                    <div class="ms-4">
                        <div class="input-group input-group-sm">
                            <span class="input-group-text">Once every</span>
                            <input type="number" class="form-control" name="EveryNSeconds" value="@Model.Config.EveryNSeconds" min="1" max="3600" />
                            <span class="input-group-text">seconds</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Save button -->
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-danger btn-lg">
                    <i class="fas fa-save me-2"></i>Save Configuration
                </button>
                <a asp-page="/Index" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Catalog
                </a>
            </div>
        </div>
    </div>
</form>

@section Scripts {
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Select All / None
        document.getElementById('selectAll').addEventListener('click', function () {
            document.querySelectorAll('.chaos-type-card input[type="checkbox"]').forEach(cb => cb.checked = true);
        });
        document.getElementById('selectNone').addEventListener('click', function () {
            document.querySelectorAll('.chaos-type-card input[type="checkbox"]').forEach(cb => cb.checked = false);
        });
        document.getElementById('selectRandom').addEventListener('click', function () {
            document.querySelectorAll('.chaos-type-card input[type="checkbox"]').forEach(cb => cb.checked = Math.random() < 0.5);
        });

        // Sync individual parameter range sliders with hidden inputs
        document.querySelectorAll('.gauge-param').forEach(function (range) {
            var targetId = range.dataset.target;
            var hidden = document.getElementById(targetId);
            var badge = document.getElementById(targetId + '_val');
            range.addEventListener('input', function () {
                hidden.value = range.value;
                badge.textContent = parseInt(range.value).toLocaleString('fr-FR');
            });
        });

        // Percentage range slider
        var pctRange = document.getElementById('Percentage_range');
        if (pctRange) {
            var pctHidden = document.getElementById('Percentage');
            var pctBadge = document.getElementById('Percentage_val');
            pctRange.addEventListener('input', function () {
                pctHidden.value = pctRange.value;
                pctBadge.textContent = pctRange.value + '%';
            });
        }

        // Global master gauge — maps 0-100% to proportional values for each parameter
        var globalGauge = document.getElementById('globalGauge');
        var globalBadge = document.getElementById('globalGaugeValue');
        globalGauge.addEventListener('input', function () {
            var pct = parseInt(globalGauge.value) / 100;
            globalBadge.textContent = globalGauge.value + '%';

            document.querySelectorAll('.gauge-param').forEach(function (range) {
                var min = parseInt(range.dataset.min);
                var max = parseInt(range.dataset.max);
                var step = parseInt(range.step) || 1;
                var val = Math.round((min + (max - min) * pct) / step) * step;
                val = Math.max(min, Math.min(max, val));
                range.value = val;
                var targetId = range.dataset.target;
                document.getElementById(targetId).value = val;
                document.getElementById(targetId + '_val').textContent = val.toLocaleString('fr-FR');
            });
        });

        // Dual-range slider for Startup Duration
        (function () {
            var minRange = document.getElementById('StartupDurationMinMs_range');
            var maxRange = document.getElementById('StartupDurationMaxMs_range');
            var minHidden = document.getElementById('StartupDurationMinMs');
            var maxHidden = document.getElementById('StartupDurationMaxMs');
            var minBadge = document.getElementById('StartupDurationMinMs_val');
            var maxBadge = document.getElementById('StartupDurationMaxMs_val');
            var fill = document.getElementById('startupFill');
            var total = parseInt(maxRange.max) - parseInt(maxRange.min);

            function updateFill() {
                var lo = parseInt(minRange.value);
                var hi = parseInt(maxRange.value);
                var rangeMin = parseInt(minRange.min);
                fill.style.left = ((lo - rangeMin) / total * 100) + '%';
                fill.style.width = ((hi - lo) / total * 100) + '%';
            }

            function fmt(v) { return parseInt(v).toLocaleString('fr-FR'); }

            minRange.addEventListener('input', function () {
                if (parseInt(minRange.value) > parseInt(maxRange.value)) {
                    minRange.value = maxRange.value;
                }
                minHidden.value = minRange.value;
                minBadge.textContent = fmt(minRange.value);
                updateFill();
            });
            maxRange.addEventListener('input', function () {
                if (parseInt(maxRange.value) < parseInt(minRange.value)) {
                    maxRange.value = minRange.value;
                }
                maxHidden.value = maxRange.value;
                maxBadge.textContent = fmt(maxRange.value);
                updateFill();
            });
            updateFill();
        })();

        // Toggle Startup Duration section visibility
        var startupCheckbox = document.getElementById('EnableLongStartup');
        var startupSection = document.getElementById('startupDurationSection');
        function toggleStartupSection() {
            startupSection.classList.toggle('d-none', !startupCheckbox.checked);
        }
        startupCheckbox.addEventListener('change', toggleStartupSection);
    });
</script>
}
