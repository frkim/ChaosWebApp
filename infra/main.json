{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.38.33.27573",
      "templateHash": "30218361296324718"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region for all resources."
      }
    },
    "appName": {
      "type": "string",
      "defaultValue": "chaoswebapp",
      "metadata": {
        "description": "Base name used to derive all resource names."
      }
    },
    "containerImage": {
      "type": "string",
      "defaultValue": "mcr.microsoft.com/dotnet/samples:aspnetapp",
      "metadata": {
        "description": "Full container image reference, e.g. myregistry.azurecr.io/chaoswebapp:latest"
      }
    },
    "appConfigSku": {
      "type": "string",
      "defaultValue": "Standard",
      "metadata": {
        "description": "Azure App Configuration SKU (Free: 1k req/day, 10MB | Standard: unlimited)."
      }
    },
    "aspNetCoreEnvironment": {
      "type": "string",
      "defaultValue": "Production",
      "metadata": {
        "description": "ASP.NET Core environment (Development / Production)."
      }
    }
  },
  "variables": {
    "uniqueSuffix": "[uniqueString(resourceGroup().id)]",
    "acrName": "[format('{0}{1}', replace(parameters('appName'), '-', ''), variables('uniqueSuffix'))]",
    "logAnalyticsName": "[format('{0}-logs-{1}', parameters('appName'), variables('uniqueSuffix'))]",
    "appInsightsName": "[format('{0}-ai-{1}', parameters('appName'), variables('uniqueSuffix'))]",
    "appConfigName": "[format('{0}-cfg-{1}', parameters('appName'), variables('uniqueSuffix'))]",
    "containerEnvName": "[format('{0}-env-{1}', parameters('appName'), variables('uniqueSuffix'))]",
    "containerAppName": "[format('{0}-app-{1}', parameters('appName'), variables('uniqueSuffix'))]",
    "loadTestName": "[format('{0}-lt-{1}', parameters('appName'), variables('uniqueSuffix'))]",
    "identityName": "[format('{0}-id-{1}', parameters('appName'), variables('uniqueSuffix'))]",
    "acrPullRoleId": "7f951dda-4ed3-4680-a7ca-43fe172d538d",
    "appConfigDataReaderRoleId": "516239f1-63e1-4d78-a4de-a74fb236a071"
  },
  "resources": [
    {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2023-01-31",
      "name": "[variables('identityName')]",
      "location": "[parameters('location')]"
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', variables('acrName'))]",
      "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', variables('acrName')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName')), variables('acrPullRoleId'))]",
      "properties": {
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName')), '2023-01-31').principalId]",
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('acrPullRoleId'))]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'acrDeploy')]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName'))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.AppConfiguration/configurationStores/{0}', variables('appConfigName'))]",
      "name": "[guid(resourceId('Microsoft.AppConfiguration/configurationStores', variables('appConfigName')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName')), variables('appConfigDataReaderRoleId'))]",
      "properties": {
        "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName')), '2023-01-31').principalId]",
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('appConfigDataReaderRoleId'))]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'appConfigDeploy')]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "logAnalyticsDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('logAnalyticsName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "16378416200727708464"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Log Analytics workspace."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "properties": {
                "sku": {
                  "name": "PerGB2018"
                },
                "retentionInDays": 30,
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                }
              }
            }
          ],
          "outputs": {
            "workspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('name'))]"
            },
            "primarySharedKey": {
              "type": "string",
              "value": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', parameters('name')), '2022-10-01').primarySharedKey]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "acrDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('acrName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "8432837149306787840"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Azure Container Registry (alphanumeric, 5-50 chars)."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-07-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Basic"
              },
              "properties": {
                "adminUserEnabled": true
              }
            }
          ],
          "outputs": {
            "loginServer": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('name')), '2023-07-01').loginServer]"
            },
            "resourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('name'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appInsightsDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "appInsightsName": {
            "value": "[variables('appInsightsName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logAnalyticsId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logAnalyticsDeploy'), '2025-04-01').outputs.workspaceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "2879903982502401062"
            }
          },
          "parameters": {
            "appInsightsName": {
              "type": "string",
              "metadata": {
                "description": "Application Insights resource name."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region."
              }
            },
            "logAnalyticsId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Log Analytics workspace."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('appInsightsName')]",
              "location": "[parameters('location')]",
              "kind": "web",
              "properties": {
                "Application_Type": "web",
                "WorkspaceResourceId": "[parameters('logAnalyticsId')]",
                "IngestionMode": "LogAnalytics",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            }
          ],
          "outputs": {
            "connectionString": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').ConnectionString]"
            },
            "instrumentationKey": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('appInsightsName')), '2020-02-02').InstrumentationKey]"
            },
            "resourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/components', parameters('appInsightsName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'logAnalyticsDeploy')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "appConfigDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('appConfigName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "sku": {
            "value": "[parameters('appConfigSku')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "16187327343632539911"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the App Configuration store."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region."
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Standard",
              "metadata": {
                "description": "App Configuration SKU. Free tier is limited to 1k requests/day and 10 MB. Use Standard for production."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.AppConfiguration/configurationStores",
              "apiVersion": "2023-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[parameters('sku')]"
              },
              "properties": {
                "publicNetworkAccess": "Enabled"
              }
            }
          ],
          "outputs": {
            "endpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.AppConfiguration/configurationStores', parameters('name')), '2023-03-01').endpoint]"
            },
            "resourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.AppConfiguration/configurationStores', parameters('name'))]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "containerAppDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "containerAppName": {
            "value": "[variables('containerAppName')]"
          },
          "containerEnvName": {
            "value": "[variables('containerEnvName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "containerImage": {
            "value": "[parameters('containerImage')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logAnalyticsDeploy'), '2025-04-01').outputs.workspaceId.value]"
          },
          "logAnalyticsWorkspaceKey": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'logAnalyticsDeploy'), '2025-04-01').outputs.primarySharedKey.value]"
          },
          "appInsightsConnectionString": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appInsightsDeploy'), '2025-04-01').outputs.connectionString.value]"
          },
          "appConfigEndpoint": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appConfigDeploy'), '2025-04-01').outputs.endpoint.value]"
          },
          "aspNetCoreEnvironment": {
            "value": "[parameters('aspNetCoreEnvironment')]"
          },
          "acrLoginServer": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', 'acrDeploy'), '2025-04-01').outputs.loginServer.value]"
          },
          "managedIdentityId": {
            "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName'))]"
          },
          "managedIdentityClientId": {
            "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName')), '2023-01-31').clientId]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "911899349706255987"
            }
          },
          "parameters": {
            "containerAppName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container App."
              }
            },
            "containerEnvName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container Apps Environment."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region."
              }
            },
            "containerImage": {
              "type": "string",
              "metadata": {
                "description": "Full container image reference."
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics workspace resource ID."
              }
            },
            "logAnalyticsWorkspaceKey": {
              "type": "securestring",
              "metadata": {
                "description": "Log Analytics workspace primary shared key."
              }
            },
            "appInsightsConnectionString": {
              "type": "securestring",
              "metadata": {
                "description": "Application Insights connection string."
              }
            },
            "appConfigEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Azure App Configuration endpoint URL."
              }
            },
            "aspNetCoreEnvironment": {
              "type": "string",
              "metadata": {
                "description": "ASP.NET Core environment name."
              }
            },
            "acrLoginServer": {
              "type": "string",
              "metadata": {
                "description": "ACR login server."
              }
            },
            "managedIdentityId": {
              "type": "string",
              "metadata": {
                "description": "User-assigned managed identity resource ID."
              }
            },
            "managedIdentityClientId": {
              "type": "string",
              "metadata": {
                "description": "User-assigned managed identity client ID."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2024-03-01",
              "name": "[parameters('containerEnvName')]",
              "location": "[parameters('location')]",
              "properties": {
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[reference(parameters('logAnalyticsWorkspaceId'), '2022-10-01').customerId]",
                    "sharedKey": "[parameters('logAnalyticsWorkspaceKey')]"
                  }
                }
              }
            },
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('containerAppName')]",
              "location": "[parameters('location')]",
              "tags": {
                "azd-service-name": "chaoswebapp"
              },
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('managedIdentityId'))]": {}
                }
              },
              "properties": {
                "environmentId": "[resourceId('Microsoft.App/managedEnvironments', parameters('containerEnvName'))]",
                "configuration": {
                  "secrets": [
                    {
                      "name": "ai-connection-string",
                      "value": "[parameters('appInsightsConnectionString')]"
                    }
                  ],
                  "ingress": {
                    "external": true,
                    "targetPort": 8080,
                    "transport": "http",
                    "allowInsecure": false
                  },
                  "registries": [
                    {
                      "server": "[parameters('acrLoginServer')]",
                      "identity": "[parameters('managedIdentityId')]"
                    }
                  ]
                },
                "template": {
                  "containers": [
                    {
                      "name": "chaoswebapp",
                      "image": "[parameters('containerImage')]",
                      "resources": {
                        "cpu": "[json('0.5')]",
                        "memory": "1Gi"
                      },
                      "env": [
                        {
                          "name": "ASPNETCORE_ENVIRONMENT",
                          "value": "[parameters('aspNetCoreEnvironment')]"
                        },
                        {
                          "name": "ASPNETCORE_URLS",
                          "value": "http://+:8080"
                        },
                        {
                          "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
                          "secretRef": "ai-connection-string"
                        },
                        {
                          "name": "AZURE_APPCONFIG_ENDPOINT",
                          "value": "[parameters('appConfigEndpoint')]"
                        },
                        {
                          "name": "AZURE_CLIENT_ID",
                          "value": "[parameters('managedIdentityClientId')]"
                        }
                      ],
                      "probes": [
                        {
                          "type": "Liveness",
                          "httpGet": {
                            "path": "/health/live",
                            "port": 8080,
                            "scheme": "HTTP"
                          },
                          "initialDelaySeconds": 15,
                          "periodSeconds": 30,
                          "failureThreshold": 3
                        },
                        {
                          "type": "Readiness",
                          "httpGet": {
                            "path": "/health/ready",
                            "port": 8080,
                            "scheme": "HTTP"
                          },
                          "initialDelaySeconds": 10,
                          "periodSeconds": 15,
                          "failureThreshold": 3
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": 1,
                    "maxReplicas": 5,
                    "rules": [
                      {
                        "name": "http-scaling",
                        "http": {
                          "metadata": {
                            "concurrentRequests": "20"
                          }
                        }
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.App/managedEnvironments', parameters('containerEnvName'))]"
              ]
            }
          ],
          "outputs": {
            "fqdn": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.App/containerApps', parameters('containerAppName')), '2024-03-01').configuration.ingress.fqdn)]"
            },
            "resourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/containerApps', parameters('containerAppName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', 'acrDeploy')]",
        "[extensionResourceId(resourceId('Microsoft.ContainerRegistry/registries', variables('acrName')), 'Microsoft.Authorization/roleAssignments', guid(resourceId('Microsoft.ContainerRegistry/registries', variables('acrName')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName')), variables('acrPullRoleId')))]",
        "[resourceId('Microsoft.Resources/deployments', 'appConfigDeploy')]",
        "[resourceId('Microsoft.Resources/deployments', 'appInsightsDeploy')]",
        "[resourceId('Microsoft.Resources/deployments', 'logAnalyticsDeploy')]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('identityName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "loadTestingDeploy",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[variables('loadTestName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.38.33.27573",
              "templateHash": "14180538827355820229"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the Azure Load Testing resource."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.LoadTestService/loadTests",
              "apiVersion": "2022-12-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "properties": {}
            }
          ],
          "outputs": {
            "resourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.LoadTestService/loadTests', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            }
          }
        }
      }
    }
  ],
  "outputs": {
    "containerAppUrl": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'containerAppDeploy'), '2025-04-01').outputs.fqdn.value]"
    },
    "appInsightsConnectionString": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appInsightsDeploy'), '2025-04-01').outputs.connectionString.value]"
    },
    "acrLoginServer": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'acrDeploy'), '2025-04-01').outputs.loginServer.value]"
    },
    "appConfigEndpoint": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'appConfigDeploy'), '2025-04-01').outputs.endpoint.value]"
    },
    "loadTestResourceId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Resources/deployments', 'loadTestingDeploy'), '2025-04-01').outputs.resourceId.value]"
    }
  }
}